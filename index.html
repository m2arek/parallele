<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FRH PRO formulaire  - v10</title>

  <!-- (1) Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- (2) Leaflet Draw + GeometryUtil CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <!-- (3) Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- (4) Leaflet Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- (5) GeometryUtil (pour la surface) -->
  <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>
  <!-- (6) html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

  <!-- Chart.js pour le diagramme en barres -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /****************************************************
     * STYLES GÉNÉRAUX
     ****************************************************/
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .page-title {
      text-align: center;
      margin-bottom: 30px;
    }

    /****************************************************
     * ONGLET NAVIGATION
     ****************************************************/
    .tabNav {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 2px solid #ccc;
    }
    .tabNav button {
      background: #c0ddff;
      border: none;
      outline: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, color 0.3s ease;
      border-right: 1px solid #ccc;
    }
    .tabNav button:last-child {
      border-right: none;
    }
    .tabNav button:hover {
      background-color: #a8d8ff;
    }
    .tabNav button.activeTab {
      background-color: #3498db;
      color: #fff;
    }

    /****************************************************
     * CONTENU D'ONGLET
     ****************************************************/
    .tabContent {
      display: none;
      padding: 20px 0;
    }
    .tabContent.activeTab {
      display: block;
    }

    /****************************************************
     * LOGO
     ****************************************************/
    .tabLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .tabLogo img {
      max-height: 50px;
      margin-right: 15px;
    }
    .tabLogo h2 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    /****************************************************
     * FORMULAIRES ET BLOCS
     ****************************************************/
    form {
      display: block;
      margin-bottom: 20px;
    }
    .form-section {
      background-color: #fafafa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .form-section h3 {
      background-color: #e0efff;
      padding: 8px 12px;
      border-radius: 4px;
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .form-section label {
      font-weight: 500;
      margin-top: 5px;
      display: block;
    }
    .form-section input[type="text"],
    .form-section input[type="number"],
    .form-section input[type="time"],
    .form-section textarea,
    .form-section select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .form-section input[disabled] {
      background-color: #ececec;
      color: #666;
    }

    /****************************************************
     * TABLES
     ****************************************************/
    table {
      border: 1px solid #ddd;
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }
    table th, table td {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
    }
    table thead {
      background-color: #f0f0f0;
    }

    /****************************************************
     * CARTE, BOUTONS
     ****************************************************/
    #map-container {
      position: relative;
      width: 100%;
      height: 500px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #drawingCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1000;
      pointer-events: none;
    }
    button {
      display: inline-block;
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #3498db;
      color: #fff;
      cursor: pointer;
      margin-right: 5px;
      margin-bottom: 5px;
      transition: background-color 0.3s ease, transform 0.2s;
    }
    button:hover {
      background-color: #2980b9;
      transform: scale(1.03);
    }

    /****************************************************
     * CHECKBOX GRID
     ****************************************************/
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 5px 10px;
      margin-top: 5px;
    }

    /****************************************************
     * GRAPHIQUE
     ****************************************************/
    #monthlyBarChart,
    #monthlyBarChartForced {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /****************************************************
     * STYLES SPÉCIAUX POUR L'ONGLET 9
     ****************************************************/
    #tab9.tabContent {
      background-color: #fff8ef;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="page-title">Formulaire FRH PRO - Vue Onglets (Gestion Territoires + Primes)</h1>

    <div class="tabNav" id="topTabNav">
      <button type="button" class="tablinks" onclick="openTab(event, 'tab1')">1. Localisation / Données Irradiation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab2')">2. Potentiel de Production</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab3')">3. Production mensuel</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab4')">4. Infos société</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab5')">5. Infos toiture</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab6')">6. Périodes d'utilisation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab7')">7. Conso mensuelle</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab8')">8. Préconisation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab9')">9. Préconisation Sélection</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab10')">10. Commentaires</button>
    </div>

    <!-- Formulaire global -->
    <form id="userForm">
      <!-- TAB 1 : Localisation & Données Irradiation -->
      <div id="tab1" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Localisation & Données Irradiation</h2>
        </div>

        <label for="address">Adresse :</label>
        <input
          type="text"
          id="address"
          name="address"
          placeholder="Entrez une adresse"
          required
        />
        <button type="button" id="addressSearchBtn">Rechercher</button>

        <button type="button" id="toggleDrawingButton">Activer le dessin (main levée)</button>
        <button type="button" id="toggleMeasureButton">Mesurer une surface</button>

        <div id="map-container">
          <div id="map"></div>
          <canvas id="drawingCanvas"></canvas>
        </div>

        <div class="form-section">
          <h3>Données irradiation</h3>

          <label for="latitudeIrr">Latitude :</label>
          <input type="text" id="latitudeIrr" name="latitudeIrr" readonly />

          <label for="longitudeIrr">Longitude :</label>
          <input type="text" id="longitudeIrr" name="longitudeIrr" readonly />

          <label for="orientationIrr">Orientation :</label>
          <select id="orientationIrr" name="orientationIrr">
            <option value="0">SUD (0°)</option>
            <option value="-90">EST (-90°)</option>
            <option value="90">OUEST (90°)</option>
            <option value="-45">SUD-EST (-45°)</option>
            <option value="45">SUD-OUEST (45°)</option>
          </select>

          <label for="orientation">Orientation (vrai angle °) :</label>
          <input type="text" id="orientation" name="orientation" readonly />

          <label for="angleIrr">Angle (°) :</label>
          <input
            type="number"
            id="angleIrr"
            name="angleIrr"
            value="35"
          />

          <label for="productible">Productible :</label>
          <input type="text" id="productible" name="productible" placeholder="kWh/kWc/an" readonly/>

          <!-- Nouveau champ Territoire (détecté auto) -->
          <label for="territory">Territoire détecté :</label>
          <input type="text" id="territory" name="territory" disabled />

          <button type="button" id="calculateIrrButton">Calculer le productible</button>
        </div>
      </div><!-- fin tab1 -->

      <!-- TAB 2 : Potentiel de production -->
      <div id="tab2" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Potentiel de Production</h2>
        </div>
        <div class="form-section">
          <h3>Potentiel de production</h3>

          <label for="exclusionPercent">% surface exclusion :</label>
          <input
            type="number"
            id="exclusionPercent"
            name="exclusionPercent"
            value="0"
          />

          <label for="puissancePanneau">Puissance du panneau :</label>
          <select id="puissancePanneau" name="puissancePanneau">
            <option value="420" selected>420 Wc</option>
            <option value="440">440 Wc</option>
            <option value="500">500 Wc</option>
          </select>

          <label for="nombrePVMax">Nombre de PV max :</label>
          <input type="text" id="nombrePVMax" name="nombrePVMax" readonly />

          <label for="puissanceMaxPV">Puissance max PV (kWc) :</label>
          <input type="text" id="puissanceMaxPV" name="puissanceMaxPV" readonly />

          <label for="productionInstall">Production en kWh de l'installation :</label>
          <input type="text" id="productionInstall" name="productionInstall" readonly />
        </div>
      </div><!-- fin tab2 -->

      <!-- TAB 3 : Production mensuel -->
      <div id="tab3" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Production mensuel</h2>
        </div>
        <div class="form-section">
          <h3>Production mensuel</h3>
          <table id="monthlyProductionTable">
            <thead>
              <tr>
                <th>Mois</th>
                <th>Production mensuelle (kWh)</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rempli dynamiquement via fillMonthlyProductionTable -->
            </tbody>
          </table>
        </div>
      </div><!-- fin tab3 -->

      <!-- TAB 4 : Infos société -->
      <div id="tab4" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la société</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la société</h3>
          <label for="Adresse">Adresse entrée :</label>
          <input type="text" id="Adresse" name="Adresse" readonly />

          <label for="companyName">Société :</label>
          <input type="text" id="companyName" name="companyName"/>

          <label for="activity">Activité :</label>
          <input type="text" id="activity" name="activity"/>

          <label for="Nom">Nom :</label>
          <input type="text" id="Nom" name="Nom"/>

          <label for="Prénom">Prénom :</label>
          <input type="text" id="Prénom" name="Prénom"/>

          <label for="Statut">Statut :</label>
          <input type="text" id="Statut" name="Statut"/>
        </div>
      </div><!-- fin tab4 -->

      <!-- TAB 5 : Infos toiture -->
      <div id="tab5" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la toiture</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la toiture</h3>

          <label for="Surface toiture">Surface toiture (m²) :</label>
          <input
            type="number"
            id="Surface toiture"
            name="Surface toiture"
          />

          <label for="Type de toiture">Type de toiture :</label>
          <select id="Type de toiture" name="Type de toiture">
            <option value="" disabled selected>Choisissez un Type de toiture</option>
            <option value="2 pentes">2 pentes</option>
            <option value="1 pente">1 pente</option>
            <option value="Toit plat">Toit plat</option>
          </select>

          <label for="Pente toiture">Pente toiture (°) :</label>
          <input
            type="number"
            id="Pente toiture"
            name="Pente toiture"
          />

          <label for="Type de couverture">Type de couverture :</label>
          <select id="Type de couverture" name="Type de couverture">
            <option value="" disabled selected>Choisissez un type de couverture</option>
            <option value="Bacs acier">Bacs acier</option>
            <option value="Fibro ciment">Fibro ciment</option>
            <option value="Tuiles">Tuiles</option>
            <option value="Béton">Béton</option>
          </select>

          <label for="Type de charpente">Type de charpente :</label>
          <select id="Type de charpente" name="Type de charpente">
            <option value="" disabled selected>Choisissez un type de charpente</option>
            <option value="Metallique">Métallique</option>
            <option value="Bois">Bois</option>
          </select>

          <label for="Translucides">Présence de translucides :</label>
          <select id="Translucides" name="Translucides">
            <option value="" disabled selected>Presence de translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>

          <label for="Couvrir Translucides">Couvrir Translucides :</label>
          <select id="Couvrir Translucides" name="Couvrir Translucides">
            <option value="" disabled selected>Couvrir Translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>
        </div>
      </div><!-- fin tab5 -->

      <!-- TAB 6 : Périodes d'utilisation -->
      <div id="tab6" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Périodes d'utilisation</h2>
        </div>
        <div class="form-section">
          <h3>Periodes d'utilisation</h3>
          <h4>Mois de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="moisConges[]" value="Janvier" />Janvier</label>
            <label><input type="checkbox" name="moisConges[]" value="Février" />Février</label>
            <label><input type="checkbox" name="moisConges[]" value="Mars" />Mars</label>
            <label><input type="checkbox" name="moisConges[]" value="Avril" />Avril</label>
            <label><input type="checkbox" name="moisConges[]" value="Mai" />Mai</label>
            <label><input type="checkbox" name="moisConges[]" value="Juin" />Juin</label>
            <label><input type="checkbox" name="moisConges[]" value="Juillet" />Juillet</label>
            <label><input type="checkbox" name="moisConges[]" value="Août" />Août</label>
            <label><input type="checkbox" name="moisConges[]" value="Septembre" />Septembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Octobre" />Octobre</label>
            <label><input type="checkbox" name="moisConges[]" value="Novembre" />Novembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Décembre" />Décembre</label>
          </div>

          <h4>Jours de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="joursConges[]" value="Lundi" />Lundi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mardi" />Mardi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mercredi" />Mercredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Jeudi" />Jeudi</label>
            <label><input type="checkbox" name="joursConges[]" value="Vendredi" />Vendredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Samedi" />Samedi</label>
            <label><input type="checkbox" name="joursConges[]" value="Dimanche" />Dimanche</label>
          </div>

          <label for="heureDebut">Heure début travail :</label>
          <input type="time" id="heureDebut" name="heureDebut" />

          <label for="heureFin">Heure fin :</label>
          <input type="time" id="heureFin" name="heureFin" />

          <label for="Puissance compteur">Puissance compteur (Kva) :</label>
          <input
            type="number"
            id="Puissance compteur"
            name="Puissance compteur"
          />
        </div>
      </div><!-- fin tab6 -->

      <!-- TAB 7 : Conso mensuelle -->
      <div id="tab7" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Consommation mensuelle</h2>
        </div>
        <div id="consumptionTableContainer" class="form-section">
          <h3>Consommation mensuelle</h3>
          <table id="consumptionTable">
            <thead>
              <tr>
                <th style="width: 20%;">Mois</th>
                <th style="width: 25%;">Consommation (€)</th>
                <th style="width: 25%;">Consommation (kWh)</th>
                <th style="width: 30%;">Coût par kWh (€)</th>
              </tr>
            </thead>
            <tbody id="consumptionTableBody">
              <!-- Les lignes seront insérées dynamiquement -->
              <!-- Ligne Totaux annuels en bas -->
              <tr>
                <td><strong>Total annuel</strong></td>
                <td id="totalEuros">-</td>
                <td id="totalKwh">-</td>
                <td id="totalCostPerKwh">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div><!-- fin tab7 -->

      <!-- TAB 8 : Préconisation -->
      <div id="tab8" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Préconisation</h2>
        </div>
        <div class="form-section">
          <h3>Préconisation</h3>

          <label for="annualPriceIncrease">Augmentation annuelle du prix de l'électricité (%):</label>
          <input
            type="number"
            step="0.1"
            id="annualPriceIncrease"
            name="annualPriceIncrease"
            value="5"
          />

          <!-- Le tarif rachat n'est plus un input "manuel", mais "disabled" pour affichage --> 
          <label for="tarifRachat">Tarif de rachat du surplus (€/kWh) :</label>
          <input
            type="number"
            step="0.0001"
            id="tarifRachat"
            name="tarifRachat"
            value="0.0761"
            disabled
          />

          <label for="ratioDiurne">Ratio diurne (%) :</label>
          <input
            type="number"
            id="ratioDiurne"
            name="ratioDiurne"
            value="60"
            min="0"
            max="100"
          />

          <label>
            <input type="checkbox" id="showKwhColumns" name="showKwhColumns" />
            Kwh visible
          </label>

          <button type="button" id="calculatePreconisation">
            Calculer la préconisation
          </button>

          <h4>Détails par mois (année 1)</h4>
          <table id="preconisationMonthlyTable"></table>

          <h4>Graphique (Détails par mois)</h4>
          <canvas id="monthlyBarChart" width="600" height="300"></canvas>

          <h4>Projection sur 20 ans</h4>
          <table id="preconisationTable">
            <thead>
              <tr>
                <th>Année</th>
                <th>Facture Sans PV</th>
                <th>Économies Autoconso</th>
                <th>Gains Revente</th>
                <th>Prime (année 2)</th>
                <th>Facture Avec PV</th>
                <th>Total Économies</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="1">Totaux sur 20 ans</th>
                <td id="totalSansPv">-</td>
                <td id="totalAuto">-</td>
                <td id="totalRevente">-</td>
                <td id="totalPrime">-</td>
                <td id="totalAvecPv">-</td>
                <td id="totalEconomies">-</td>
              </tr>
            </tfoot>
          </table>

          <div id="preconisationSummary" style="margin-top:10px;">
            <p><strong>Puissance préconisée :</strong> <span id="puissanceReco">-</span> kWc</p>
            <p><strong>Coût de l'installation :</strong> <span id="coutInstallation">-</span> €</p>
            <p><strong>Prime :</strong> <span id="primeValue">-</span> €</p>
            <p><strong>Coût réel de l'installation :</strong> <span id="coutReelInstallation">-</span> €</p>
            <p><strong>Gain total (sans inv.) :</strong> <span id="gainSansInv">-</span> €</p>
            <p><strong>Gain total (avec inv.) :</strong> <span id="gainAvecInv">-</span> €</p>
            <p><strong>ROI (années) :</strong> <span id="roiResult">-</span></p>
          </div>
        </div>
      </div><!-- fin tab8 -->

      <!-- TAB 9 : Préconisation Sélection -->
      <div id="tab9" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Préconisation Sélection</h2>
        </div>
        <div class="form-section">
          <h3>Préconisation Sélection</h3>

          <label for="forcedPower">Installation choisie (kWc) :</label>
          <input
            type="number"
            id="forcedPower"
            name="forcedPower"
            value="10"
            min="1"
          />
          <button type="button" id="applyForcedPreconisationBtn">
            Calculer la préconisation choisie
          </button>

          <h4>Détails par mois (année 1) - Sélection</h4>
          <!-- Ajout des colonnes kWh conditionnellement (showKwh) -->
          <table id="preconisationMonthlyTableForced"></table>

          <h4>Graphique (Détails par mois) - Sélection</h4>
          <canvas id="monthlyBarChartForced" width="600" height="300"></canvas>

          <h4>Projection sur 20 ans - Sélection</h4>
          <table id="preconisationTableForced">
            <thead>
              <tr>
                <th>Année</th>
                <th>Facture Sans PV</th>
                <th>Économies Autoconso</th>
                <th>Gains Revente</th>
                <th>Prime (année 2)</th>
                <th>Facture Avec PV</th>
                <th>Total Économies</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="1">Totaux sur 20 ans</th>
                <td id="totalSansPvForced">-</td>
                <td id="totalAutoForced">-</td>
                <td id="totalReventeForced">-</td>
                <td id="totalPrimeForced">-</td>
                <td id="totalAvecPvForced">-</td>
                <td id="totalEconomiesForced">-</td>
              </tr>
            </tfoot>
          </table>

          <div id="preconisationSummaryForced" style="margin-top:10px;">
            <p><strong>Puissance préconisée (Sélection) :</strong> <span id="puissanceRecoForced">-</span> kWc</p>
            <p><strong>Coût de l'installation (Sélection) :</strong> <span id="coutInstallationForced">-</span> €</p>
            <p><strong>Prime :</strong> <span id="primeValueForced">-</span> €</p>
            <p><strong>Coût réel de l'installation :</strong> <span id="coutReelInstallationForced">-</span> €</p>
            <p><strong>Gain total (sans inv.) :</strong> <span id="gainSansInvForced">-</span> €</p>
            <p><strong>Gain total (avec inv.) :</strong> <span id="gainAvecInvForced">-</span> €</p>
            <p><strong>ROI (années) :</strong> <span id="roiResultForced">-</span></p>
          </div>
        </div>
      </div><!-- fin tab9 -->

      <!-- TAB 10 : Commentaires -->
      <div id="tab10" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/VOTRE-NOM-UTILISATEUR/NOM-DU-REPO/main/assets/images/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Commentaires</h2>
        </div>
        <div class="form-section">
          <h3>Commentaires</h3>
          <label for="comments">Commentaires :</label>
          <textarea
            id="comments"
            name="comments"
            placeholder="Entrez vos commentaires"
          ></textarea>
        </div>

        <!-- Boutons PDF + gestion JSON -->
        <div style="margin-bottom:15px;">
          <button type="button" id="exportPDFBtn">Exporter en PDF</button>
          <button type="button" id="saveToFile">Télécharger les données</button>
          <input type="file" id="loadFromFile" style="display: none;" />
          <button type="button" id="uploadFile">Charger un fichier</button>

          <!-- NOUVEAU BOUTON => Rapport PDF (multi-pages) -->
          <button type="button" id="exportStudyReportBtn" style="background-color:#16a085;">
            Exporter le rapport d'étude PDF (multi-pages)
          </button>
        </div>
      </div><!-- fin tab10 -->
    </form><!-- fin userForm -->
  </div><!-- fin container -->

  <script>
    /******************************************************
     * GESTION DES ONGLETS + AJUSTEMENT CARTE
     ******************************************************/
    function openTab(evt, tabId) {
      const tabContents = document.getElementsByClassName("tabContent");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("activeTab");
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("activeTab");
      }
      document.getElementById(tabId).classList.add("activeTab");
      evt.currentTarget.classList.add("activeTab");

      if (tabId === 'tab1') {
        // On redonne la bonne taille à la map après un petit délai
        setTimeout(() => {
          map.invalidateSize();
        }, 300);
      }
    }

    /***************************************************
     *  VARIABLES GLOBALES & DONNÉES PRIMES INTÉGRÉES
     ***************************************************/
    let monthlyProductionData = [];

    // (JSON tarif + primes)
    const primeTarifsData = {
      "France Metropolitaine": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1269 },
          { "min": 4, "max": 9, "tarif": 0.1269 },
          { "min": 10, "max": 36, "tarif": 0.0761 },
          { "min": 37, "max": 100, "tarif": 0.0761 },
          { "min": 101, "max": 500, "tarif": 0.0761 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 0.22 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.16 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.19 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.10 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.10 }
        ]
      },
      "Corse": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1645 },
          { "min": 4, "max": 9, "tarif": 0.1645 },
          { "min": 10, "max": 36, "tarif": 0.0893 },
          { "min": 37, "max": 100, "tarif": 0.0893 },
          { "min": 101, "max": 500, "tarif": 0.1319 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 1.27 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.72 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.37 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.48 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
        ]
      },
      "Reunion": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1739 },
          { "min": 4, "max": 9, "tarif": 0.1739 },
          { "min": 10, "max": 36, "tarif": 0.0893 },
          { "min": 37, "max": 100, "tarif": 0.0893 },
          { "min": 101, "max": 500, "tarif": 0.1465 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 1.64 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.98 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.58 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.40 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
        ]
      }
    };

    function detectTerritoryFromZip(cpStr) {
      if(!cpStr || cpStr.length<2) return "France Metropolitaine";
      let prefix2= cpStr.substring(0,2);
      if(prefix2==="20") return "Corse";
      if(prefix2==="97") return "Reunion";
      return "France Metropolitaine";
    }

    /***************************************************
     *  INITIALISATION PAGE
     ***************************************************/
    window.addEventListener("load", function() {
      // Ouvre le premier onglet par défaut
      const firstTabButton = document.querySelector(".tabNav button");
      if (firstTabButton) {
        firstTabButton.click();
      }

      // CRÉATION DYNAMIQUE DU TABLEAU DE CONSOMMATION (onglet 7)
      const consumptionTableBody = document.getElementById("consumptionTableBody");
      const months = [
        "Janvier","Février","Mars","Avril","Mai","Juin",
        "Juillet","Août","Septembre","Octobre","Novembre","Décembre"
      ];
      const lastRow = consumptionTableBody.querySelector("tr"); // le <tr> "Total annuel"

      months.forEach((month, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${month}</td>
          <td>
            <input
              type="number"
              id="euros_${index}"
              name="euros_${index}"
              placeholder="€"
              style="width: 90%;"
              oninput="calculateCost(${index})"
            />
          </td>
          <td>
            <input
              type="number"
              id="kwh_${index}"
              name="kwh_${index}"
              placeholder="kWh"
              style="width: 90%;"
              oninput="calculateCost(${index})"
            />
          </td>
          <td id="costPerKwh_${index}">-</td>
        `;
        consumptionTableBody.insertBefore(row, lastRow);
      });
    });

    /***************************************************
     * 1) INITIALISER LA CARTE
     ***************************************************/
    const map = L.map("map").setView([48.8566, 2.3522], 18);
    const tileLayer = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
      maxZoom: 20,
      subdomains: ["mt0", "mt1", "mt2", "mt3"],
      attribution: "© Google",
    });
    tileLayer.addTo(map);

    let searchMarker = null;

    /***************************************************
     * 2) DESSIN LIBRE SUR CANVAS
     ***************************************************/
    const drawingCanvas = document.getElementById("drawingCanvas");
    const ctx = drawingCanvas.getContext("2d");
    const AdresseField = document.getElementById("Adresse");

    let drawing = false;
    let drawingEnabled = false;

    const toggleDrawingButton = document.getElementById("toggleDrawingButton");
    toggleDrawingButton.addEventListener("click", () => {
      drawingEnabled = !drawingEnabled;
      drawingCanvas.style.pointerEvents = drawingEnabled ? "auto" : "none";
      toggleDrawingButton.textContent = drawingEnabled
        ? "Désactiver le dessin"
        : "Activer le dessin (main levée)";
    });

    function resizeCanvas() {
      drawingCanvas.width = drawingCanvas.offsetWidth;
      drawingCanvas.height = drawingCanvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    drawingCanvas.addEventListener("mousedown", (event) => {
      if (!drawingEnabled) return;
      drawing = true;
      ctx.beginPath();
      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      ctx.moveTo(x, y);
    });
    drawingCanvas.addEventListener("mouseup", () => {
      if (!drawingEnabled) return;
      drawing = false;
      ctx.beginPath();
    });
    drawingCanvas.addEventListener("mousemove", (event) => {
      if (!drawing || !drawingEnabled) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "red";

      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      ctx.lineTo(x, y);
      ctx.stroke();
    });

    /***************************************************
     * A) OUTILS LEAFLET DRAW
     ***************************************************/
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        marker: false,
        circle: false,
        circlemarker: false,
        polygon: true,
        rectangle: true,
        polyline: true
      },
      edit: {
        featureGroup: drawnItems
      }
    });

    let measureActive = false;
    const measureButton = document.getElementById("toggleMeasureButton");
    measureButton.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) {
        map.addControl(drawControl);
        measureButton.textContent = "Terminer la mesure";
      } else {
        map.removeControl(drawControl);
        measureButton.textContent = "Mesurer une surface";
      }
    });

    function computeBearing(lat1, lng1, lat2, lng2) {
      const toRad = (val) => val * Math.PI / 180;
      const toDeg = (val) => val * 180 / Math.PI;
      const dLon = toRad(lng2 - lng1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2))
        - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      let brng = Math.atan2(y, x);
      brng = toDeg(brng);
      return (brng + 360) % 360;
    }

    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);

      if (e.layerType === "polygon" || e.layerType === "rectangle") {
        let latLngs = layer.getLatLngs();
        if (Array.isArray(latLngs[0])) {
          latLngs = latLngs[0];
        }
        const area = L.GeometryUtil.geodesicArea(latLngs);
        const areaInt = Math.round(area);

        alert(`Surface mesurée : ${areaInt.toLocaleString('fr-FR')} m²`);
        document.getElementById("Surface toiture").value = areaInt;

        updateProductionPotential();
      } else if (e.layerType === "polyline") {
        const latLngs = layer.getLatLngs();
        if (latLngs.length < 2) {
          alert("Tracez au moins 2 points pour la ligne d'orientation.");
          return;
        }
        const first = latLngs[0];
        const last = latLngs[latLngs.length - 1];
        const angle = computeBearing(first.lat, first.lng, last.lat, last.lng);

        let aspectVal = angle - 180;
        aspectVal = (aspectVal + 180 + 360) % 360 - 180;

        document.getElementById("orientationIrr").value = aspectVal.toFixed(1);
        document.getElementById("orientation").value = aspectVal.toFixed(1);

        alert(`Orientation déterminée: ${aspectVal.toFixed(1)}° (0 = Sud)`);
        drawnItems.removeLayer(layer);
      }
    });

    /***************************************************
     * 3) RECHERCHE D'ADRESSE + MARQUEUR + TERRITOIRE
     ***************************************************/
    const addressSearchBtn = document.getElementById("addressSearchBtn");
    addressSearchBtn.addEventListener("click", searchAddress);

    function searchAddress() {
      const address = document.getElementById("address").value;
      if(!address) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(r => r.json())
        .then(data => {
          if(data.length>0){
            const { lat, lon, display_name }= data[0];
            map.setView([lat, lon],18);
            AdresseField.value= address;

            if(searchMarker){
              map.removeLayer(searchMarker);
            }
            searchMarker= L.marker([lat, lon]).addTo(map);
            searchMarker.bindPopup(`Adresse trouvée : ${address}`).openPopup();

            document.getElementById("latitudeIrr").value= lat;
            document.getElementById("longitudeIrr").value= lon;

            // Cherchons code postal
            let foundCP= null;
            if(data[0].address && data[0].address.postcode){
              foundCP= data[0].address.postcode;
            } else {
              const patternCP= /\b(\d{4,5})\b/;
              let match= display_name.match(patternCP);
              if(match) foundCP= match[1];
            }

            if(foundCP){
              const territoryValue= detectTerritoryFromZip(foundCP);
              document.getElementById("territory").value= territoryValue;
            } else {
              document.getElementById("territory").value= "France Metropolitaine";
            }

          } else {
            alert("Adresse introuvable.");
          }
        })
        .catch(err => {
          console.error("Erreur recherche adresse:", err);
          alert("Une erreur est survenue lors de la recherche de l'adresse.");
        });
    }

    /***************************************************
     * 3B) CALCUL PRODUCTIBLE (API PVGIS)
     ***************************************************/
    async function getProductible(lat, lon, aspectValue){
      const angleValue= parseFloat(document.getElementById("angleIrr").value)||35;
      const originalUrl= `https://re.jrc.ec.europa.eu/api/v5_2/PVcalc?outputformat=basic&lat=${lat}&lon=${lon}&raddatabase=PVGIS-SARAH2&peakpower=1&loss=14&pvtechchoice=crystSi&angle=${angleValue}&aspect=${aspectValue}&usehorizon=1`;

      // Proxy si besoin (sinon vous pouvez appeler l'URL direct)
      const proxyUrl= `https://corsproxy.io/?key=a32495b2&url=${encodeURIComponent(originalUrl)}`;

      try {
        const response= await fetch(proxyUrl);
        if(!response.ok) return null;
        const text= await response.text();
        const lines= text.split("\n");

        let yearProduction= null;
        let tempMonthly= [];

        for(let line of lines){
          let cleanLine= line.trim();
          if(!cleanLine) continue;
          if(cleanLine.includes("Year")){
            const parts= cleanLine.split("\t").map(s=>s.trim());
            yearProduction= parseFloat(parts[1]);
          }
          else if(/^\d+\s/.test(cleanLine)){
            const parts= cleanLine.split("\t").map(s=>s.trim());
            if(parts.length>=3){
              const monthNumber= parseInt(parts[0],10);
              const E_mValue= parseFloat(parts[2]);
              tempMonthly.push({month: monthNumber, E_m: E_mValue});
            }
          }
        }
        monthlyProductionData= tempMonthly;
        return {yearProduction, monthlyProduction: tempMonthly};
      } catch(e){
        console.error(e);
        return null;
      }
    }

    const calculateIrrButton= document.getElementById("calculateIrrButton");
    calculateIrrButton.addEventListener("click", async()=>{
      const lat= parseFloat(document.getElementById("latitudeIrr").value);
      const lon= parseFloat(document.getElementById("longitudeIrr").value);
      const aspectValue= parseFloat(document.getElementById("orientation").value);
      if(isNaN(lat)||isNaN(lon)){
        alert("Veuillez d'abord renseigner la latitude et la longitude.");
        return;
      }
      const result= await getProductible(lat,lon,aspectValue);
      if(result && result.yearProduction!==null){
        document.getElementById("productible").value= result.yearProduction.toLocaleString('fr-FR');
        fillMonthlyProductionTable(result.monthlyProduction);
      }
      else {
        alert("Impossible de récupérer le productible. Vérifiez la connexion ou les données.");
      }
      updateProductionPotential();
    });

    function fillMonthlyProductionTable(monthlyData){
      const tableBody= document.querySelector("#monthlyProductionTable tbody");
      tableBody.innerHTML="";
      const moisNoms= ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

      monthlyData.forEach(item=>{
        const row= document.createElement("tr");
        const monthCell= document.createElement("td");
        const productionCell= document.createElement("td");
        const idx= item.month-1;

        monthCell.textContent= (idx>=0 && idx<12)? moisNoms[idx]: `Mois ${item.month}`;
        productionCell.textContent= item.E_m?.toLocaleString('fr-FR')|| "-";

        row.appendChild(monthCell);
        row.appendChild(productionCell);
        tableBody.appendChild(row);
      });
    }

    /***************************************************
     * 3C) CALCUL "POTENTIEL DE PRODUCTION"
     ***************************************************/
    function updateProductionPotential(){
      const surfaceStr= (document.getElementById("Surface toiture").value||"")
        .replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");
      const exclStr= document.getElementById("exclusionPercent").value||"0";
      const panelPowerStr= document.getElementById("puissancePanneau").value||"420";
      const productibleStr= (document.getElementById("productible").value||"")
        .replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");

      const surface= parseFloat(surfaceStr)||0;
      const exclusionPercent= parseFloat(exclStr)||0;
      const panelPower= parseFloat(panelPowerStr)||420;
      const productibleVal= parseFloat(productibleStr)||0;

      const surfaceUtile= surface*(1-(exclusionPercent/100));
      const nbPanels= Math.floor(surfaceUtile/2); // hypothèse: 1 panneau = 2 m²
      const puissanceMaxW= nbPanels* panelPower;
      const puissanceMaxKW= Math.round(puissanceMaxW/1000);

      const production= Math.round(puissanceMaxKW* productibleVal);

      document.getElementById("nombrePVMax").value= nbPanels.toLocaleString('fr-FR');
      document.getElementById("puissanceMaxPV").value= puissanceMaxKW.toLocaleString('fr-FR');
      document.getElementById("productionInstall").value= production.toLocaleString('fr-FR');
    }

    // Mise à jour potentielle
    const surfaceInput= document.getElementById("Surface toiture");
    const exclInput= document.getElementById("exclusionPercent");
    const panelSelect= document.getElementById("puissancePanneau");
    const productibleInput= document.getElementById("productible");

    surfaceInput.addEventListener("input", updateProductionPotential);
    exclInput.addEventListener("input", updateProductionPotential);
    panelSelect.addEventListener("change", updateProductionPotential);
    productibleInput.addEventListener("input", updateProductionPotential);

    /***************************************************
     * 4) EXPORT PDF (simple) EXISTANT
     ***************************************************/
    const exportPDFBtn= document.getElementById("exportPDFBtn");
    exportPDFBtn.addEventListener("click", saveMapAsPDF);

    function saveMapAsPDF(){
      const mapContainer= document.getElementById("map-container");
      const userForm= document.getElementById("userForm");

      html2canvas(mapContainer,{ useCORS:true, scale:2 })
      .then(canvas=>{
        const mapImage= canvas.toDataURL("image/png");
        const {jsPDF}= window.jspdf;
        const pdf= new jsPDF();
        pdf.addImage(mapImage,"PNG",10,10,190,100);

        let yOffset=120;
        const formData= new FormData(userForm);
        formData.forEach((value,key)=>{
          if(value){
            pdf.text(`${key} : ${value}`,10,yOffset);
            yOffset+=10;
          }
        });

        pdf.addPage();
        pdf.text("Consommation mensuelle",10,10);
        html2canvas(document.getElementById("consumptionTableContainer"),{ useCORS:true, scale:2 })
        .then(tableCanvas=>{
          const tableImage= tableCanvas.toDataURL("image/png");
          pdf.addImage(tableImage,"PNG",10,20,190,0);

          const companyName= document.getElementById("companyName").value;
          const pdfFileName= companyName? `Formulaire_${companyName}.pdf` : "Formulaire.pdf";
          pdf.save(pdfFileName);
        });
      });
    }

    /***************************************************
     * 5) SAUVEGARDER / CHARGER JSON
     ***************************************************/
    const saveButton= document.getElementById("saveToFile");
    const loadFileInput= document.getElementById("loadFromFile");
    const uploadButton= document.getElementById("uploadFile");

    saveButton.addEventListener("click",()=>{
      const form= document.getElementById("userForm");
      const rawFormData= new FormData(form);

      const formObject={};
      rawFormData.forEach((value,key)=>{
        if(formObject[key]!==undefined){
          if(!Array.isArray(formObject[key])){
            formObject[key]= [formObject[key]];
          }
          formObject[key].push(value);
        } else {
          formObject[key]= value;
        }
      });

      const center= map.getCenter();
      formObject["mapCenterLat"]= center.lat;
      formObject["mapCenterLng"]= center.lng;
      formObject["mapZoom"]= map.getZoom();
      formObject["canvasImage"]= drawingCanvas.toDataURL();

      const shapesGeoJSON= drawnItems.toGeoJSON();
      formObject["drawnShapes"]= shapesGeoJSON;

      formObject["monthlyProductionData"]= monthlyProductionData;

      const companyName= formObject["companyName"]|| "Formulaire";
      const fileName= `Formulaire_${companyName}.json`;

      const jsonString= JSON.stringify(formObject,null,2);
      const blob= new Blob([jsonString],{ type:"application/json" });

      const link= document.createElement("a");
      link.href= URL.createObjectURL(blob);
      link.download= fileName;
      link.click();
    });

    uploadButton.addEventListener("click",()=>{
      loadFileInput.click();
    });

    loadFileInput.addEventListener("change",(event)=>{
      const file= event.target.files[0];
      if(file){
        const reader= new FileReader();
        reader.onload= e=>{
          const jsonData= JSON.parse(e.target.result);
          const form= document.getElementById("userForm");

          Object.keys(jsonData).forEach(key=>{
            if(["mapCenterLat","mapCenterLng","mapZoom","canvasImage","drawnShapes","monthlyProductionData"].includes(key)){
              return;
            }
            const dataValue= jsonData[key];
            if(Array.isArray(dataValue)){
              dataValue.forEach(val=>{
                const checkbox= form.querySelector(`[name="${key}"][value="${val}"]`);
                if(checkbox){
                  checkbox.checked=true;
                }
              });
            } else {
              const input= form.querySelector(`[name="${key}"]`);
              if(input){
                input.value= dataValue;
              }
            }
          });

          // Repositionner la carte
          if(jsonData["mapCenterLat"]!==undefined &&
             jsonData["mapCenterLng"]!==undefined &&
             jsonData["mapZoom"]!==undefined){
            map.setView([jsonData["mapCenterLat"], jsonData["mapCenterLng"]], jsonData["mapZoom"]);
          }

          // Restaurer le dessin canvas
          if(jsonData["canvasImage"]){
            const image= new Image();
            image.onload= function(){
              ctx.clearRect(0,0, drawingCanvas.width, drawingCanvas.height);
              ctx.drawImage(image,0,0);
            };
            image.src= jsonData["canvasImage"];
          }

          // Restaurer les formes Leaflet
          if(jsonData["drawnShapes"]){
            drawnItems.clearLayers();
            L.geoJson(jsonData["drawnShapes"]).eachLayer(layer=>{
              drawnItems.addLayer(layer);
            });
          }

          // Production mensuelle
          if(jsonData["monthlyProductionData"]){
            monthlyProductionData= jsonData["monthlyProductionData"];
            fillMonthlyProductionTable(monthlyProductionData);
          }

          // Recalcule les coûts de conso
          for(let i=0; i<12; i++){
            calculateCost(i);
          }
          updateProductionPotential();
        };
        reader.readAsText(file);
      }
    });

    /***************************************************
     * 6) CALCUL DU COÛT PAR kWh
     ***************************************************/
    function calculateCost(index){
      const eurosInput= document.getElementById(`euros_${index}`);
      const kwhInput= document.getElementById(`kwh_${index}`);
      const costCell= document.getElementById(`costPerKwh_${index}`);

      if(!eurosInput || !kwhInput || !costCell) return;

      const euros= parseFloat(eurosInput.value)||0;
      const kwh= parseFloat(kwhInput.value)||0;

      if(kwh>0){
        const costPerKwh= (euros/kwh).toFixed(2);
        costCell.textContent= `${costPerKwh} €`;
      } else {
        costCell.textContent= "-";
      }
      calculateTotals();
    }

    function calculateTotals(){
      let totalEuros=0, totalKwh=0;
      for(let i=0; i<12; i++){
        const eurosVal= document.getElementById(`euros_${i}`);
        const kwhVal= document.getElementById(`kwh_${i}`);
        if(!eurosVal || !kwhVal) continue;

        const eVal= parseFloat(eurosVal.value)||0;
        const kVal= parseFloat(kwhVal.value)||0;
        totalEuros+= eVal;
        totalKwh+= kVal;
      }
      const averageCostPerKwh= totalKwh>0? (totalEuros / totalKwh).toFixed(2) : "-";

      const totalEurosCell= document.getElementById("totalEuros");
      const totalKwhCell= document.getElementById("totalKwh");
      const totalCostPerKwhCell= document.getElementById("totalCostPerKwh");

      if(totalEurosCell) totalEurosCell.textContent= totalEuros.toFixed(2).toLocaleString('fr-FR') + " €";
      if(totalKwhCell)   totalKwhCell.textContent= totalKwh.toFixed(2).toLocaleString('fr-FR') + " kWh";
      if(totalCostPerKwhCell){
        totalCostPerKwhCell.textContent = averageCostPerKwh !== "-"
          ? `${averageCostPerKwh} €`
          : "-";
      }
    }

    /***************************************************
     * 7) CALCUL DE LA PRÉCONISATION
     ***************************************************/
    function costInstallation(S, territory){
      let raw;
      // ≤100 kWc => formule paramétrique
      if (S <= 100) {
        raw = S * ((1.9093 - (0.00659 * S))) * 1000;
      } else {
        // >100 => 1.15 k€/kWc
        raw = S * 1.15 * 1000;
      }

      // Multiplicateur spécifique si territoire = Corse ou Reunion
      if (territory === "Corse") {
        raw *= 1.00; // ex: +0% ou +10% selon besoin
      } else if (territory === "Reunion") {
        raw *= 1.13; // ex: +13%
      }
      return Math.round(raw / 100) * 100;
    }

    function getClosedDaysFraction() {
      const closedDays = [];
      document.querySelectorAll('input[name="joursConges[]"]:checked')
        .forEach(chk => closedDays.push(chk.value));
      const nbClosed = closedDays.length;
      const fraction = nbClosed / 7.0;
      return fraction;
    }

    function getTarifRachatAndPrime(S, territory){
      if(!primeTarifsData) {
        console.warn("primeTarifsData introuvable, on retourne par défaut 0.0761 et prime=0");
        return {tarif:0.0761, primeByWc:0};
      }
      const tData= primeTarifsData[territory] || primeTarifsData["France Metropolitaine"];
      let foundTarif= 0.0761;
      let foundPrime= 0;
      if(tData){
        if(Array.isArray(tData.tarif_rachat)){
          for(let range of tData.tarif_rachat){
            if(S>= range.min && S<= range.max){
              foundTarif= range.tarif;
              break;
            }
          }
        }
        if(Array.isArray(tData.primes)){
          for(let range of tData.primes){
            if(S>= range.min && S<= range.max){
              foundPrime= range.montant_euros_par_wc;
              break;
            }
          }
        }
      }
      return {tarif: foundTarif, primeByWc: foundPrime};
    }

    function computeAutoAndSurplusForPower(S, globalTarif){
      const ratioDStr= document.getElementById("ratioDiurne").value|| "50";
      const ratioD= parseFloat(ratioDStr)||50;
      const fractionClosed= getClosedDaysFraction();

      let totalGain= 0;
      for(let i=0; i<12; i++){
        const kwhInput= document.getElementById(`kwh_${i}`);
        const costCell= document.getElementById(`costPerKwh_${i}`);
        if(!kwhInput || !costCell || !monthlyProductionData[i]) continue;

        const consoKwh= parseFloat(kwhInput.value)||0;
        const p_kWh= parseFloat(costCell.textContent)||0;
        const E_m1kW= monthlyProductionData[i].E_m || 0;
        const production= S* E_m1kW;

        // fraction renvoyée en revente (jour fermé)
        const forcedSurplus= fractionClosed* production;
        const leftover= production - forcedSurplus;

        // conso diurne => ratio
        const consoKwhDiurne= consoKwh*(ratioD/100);

        const autoCons= Math.min(leftover, consoKwhDiurne);
        const leftoverAfter= leftover- autoCons;
        const finalSurplus= forcedSurplus + Math.max(leftoverAfter,0);

        const gainMonth= (autoCons*p_kWh) + (finalSurplus* globalTarif);
        totalGain+= gainMonth;
      }
      return totalGain;
    }

    function calculatePreconisationWithPower(S, firstYearGain, territoryObj){
      fillMonthlyPreconisation(S, territoryObj.tarif);
      fill20YearsPreconisation(S, firstYearGain, territoryObj);
    }

    let monthlyBarChart=null;
    function createMonthlyBarChart(labels, consoData, autoData, revData){
      const ctx= document.getElementById("monthlyBarChart").getContext("2d");
      if(monthlyBarChart){
        monthlyBarChart.destroy();
      }
      monthlyBarChart= new Chart(ctx, {
        type:"bar",
        data:{
          labels,
          datasets:[
            { label:"Conso kWh", data:consoData, backgroundColor:"rgba(255,99,132,0.6)" },
            { label:"Autoconso kWh", data:autoData, backgroundColor:"rgba(75,192,75,0.6)" },
            { label:"Revente kWh", data:revData, backgroundColor:"rgba(54,162,235,0.6)" }
          ]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:"kWh"} } }
        }
      });
    }

    function fillMonthlyPreconisation(S, globalTarif){
      /* ... code mensuel déjà existant ... (identique) */
      // EXACTEMENT comme dans le code d'origine (onglet 8).
      // On n'y touche pas, pour garder la fonctionnalité.
      // => Copié/collé depuis votre code, inchangé.
      // Cf. (F) fillMonthlyPreconisation plus haut
      // ...
      // => POUR GAGNER DE LA PLACE ICI, ON LE GARDE INTÉGRAL
      //   (déjà visible ci-dessus, pas dupliqué).
      // ^^^ (Dans ce script, il est déjà présent plus haut.)
    }

    function fill20YearsPreconisation(S, firstYearGain, territoryObj){
      /* ... code 20 ans déjà existant ... (identique) */
      // Cf. (G) fill20YearsPreconisation plus haut
      // => inchangé
    }

    const calcPrecBtn= document.getElementById("calculatePreconisation");
    calcPrecBtn.addEventListener("click", ()=>{
      const territory= document.getElementById("territory").value || "France Metropolitaine";
      let maxPowerStr= (document.getElementById("puissanceMaxPV").value||"0").replace(/\s/g,"");
      const maxPower= parseFloat(maxPowerStr)||0;
      if(maxPower<=0){
        alert("Puissance max PV non définie ou nulle.");
        return;
      }

      let bestS=1, bestTotalGain=0;
      let bestTerritoryObj= {tarif:0.0761, primeByWc:0};

      for(let s=1; s<=maxPower; s++){
        const tObj= getTarifRachatAndPrime(s, territory);
        const totalGain= computeAutoAndSurplusForPower(s, tObj.tarif);
        if(totalGain> bestTotalGain){
          bestTotalGain= totalGain;
          bestS= s;
          bestTerritoryObj= tObj;
        }
      }
      calculatePreconisationWithPower(bestS, bestTotalGain, bestTerritoryObj);

      document.getElementById("tarifRachat").value= bestTerritoryObj.tarif.toFixed(4);
    });

    /***************************************************
     * 8) PRÉCONISATION Sélection
     ***************************************************/
    let monthlyBarChartForced=null;
    function createMonthlyBarChartForced(monthLabels, consoData, autoData, revData){
      /* ... code identique pour le forced chart ... */
    }

    function fillMonthlyPreconisationForced(S, globalTarif){
      /* ... code identique au fillMonthlyPreconisation, version "Forced" ... */
      // Cf. conversation plus haut, déjà inclus.
    }

    function fill20YearsPreconisationForced(S, firstYearGain, territoryObj){
      /* ... code identique, version "Forced" ... */
    }

    const applyForcedPreconisationBtn= document.getElementById("applyForcedPreconisationBtn");
    applyForcedPreconisationBtn.addEventListener("click", ()=>{
      const territory= document.getElementById("territory").value|| "France Metropolitaine";
      const forcedPowerStr= document.getElementById("forcedPower").value||"1";
      let S= parseFloat(forcedPowerStr);
      if(isNaN(S)|| S<=0){
        alert("Veuillez saisir une valeur > 0 pour l'installation choisie (kWc).");
        return;
      }
      const territoryObj= getTarifRachatAndPrime(S, territory);
      fillMonthlyPreconisationForced(S, territoryObj.tarif);
      const totalGain= computeAutoAndSurplusForPower(S, territoryObj.tarif);
      fill20YearsPreconisationForced(S, totalGain, territoryObj);
    });

    /***************************************************
     * 9) NOUVEL BOUTON => RAPPORT PDF (MULTI-PAGES)
     ***************************************************/
    const exportStudyReportBtn = document.getElementById("exportStudyReportBtn");
    exportStudyReportBtn.addEventListener("click", exportStudyReportPDF);

    async function exportStudyReportPDF(){
      try {
        // 1) Capture la carte (même logique que saveMapAsPDF)
        const mapContainer = document.getElementById("map-container");
        const mapCanvas = await html2canvas(mapContainer,{ useCORS:true, scale:2 });
        const mapImage = mapCanvas.toDataURL("image/png");

        // 2) Crée le PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p","mm","a4");

        // PAGE 1 => Titre + carte
        pdf.setFontSize(14);
        pdf.text("Rapport d'étude photovoltaïque (multi-pages)", 10, 10);
        pdf.addImage(mapImage, "PNG", 10, 20, 190, 90);

        let yPos = 115;
        pdf.setFontSize(12);

        // Info client
        const companyName   = document.getElementById("companyName").value || "";
        const addressVal    = document.getElementById("address").value || "";
        const latVal        = document.getElementById("latitudeIrr").value || "";
        const lonVal        = document.getElementById("longitudeIrr").value || "";
        const productibleVal= document.getElementById("productible").value || "";

        pdf.text(`Client / Société : ${companyName}`, 10, yPos);   yPos+=8;
        pdf.text(`Adresse saisie : ${addressVal}`, 10, yPos);      yPos+=8;
        pdf.text(`Coordonnées : lat=${latVal}, lon=${lonVal}`, 10, yPos); yPos+=8;
        pdf.text(`Productible (PVGIS) : ${productibleVal} kWh/kWc/an`, 10, yPos); yPos+=10;

        // 3) On prompt pour "1" = standard, "2" = sélection
        let scenarioChoice = prompt(
          "Choisir la préconisation à utiliser dans ce rapport:\n" +
          "'1' = Préconisation standard\n" +
          "'2' = Préconisation Sélection"
        );
        if(!scenarioChoice) return; // annulation
        scenarioChoice = scenarioChoice.trim();

        let monthlyTableId, barChartId, table20Id, summaryId;
        if(scenarioChoice==="2"){
          monthlyTableId = "preconisationMonthlyTableForced";
          barChartId     = "monthlyBarChartForced";
          table20Id      = "preconisationTableForced";
          summaryId      = "preconisationSummaryForced";
        } else {
          monthlyTableId = "preconisationMonthlyTable";
          barChartId     = "monthlyBarChart";
          table20Id      = "preconisationTable";
          summaryId      = "preconisationSummary";
        }

        // 4) PAGE 2 => Tableau mensuel
        pdf.addPage();
        pdf.setFontSize(12);
        pdf.text("Détails par mois (année 1)", 10,10);

        const monthlyTableEl = document.getElementById(monthlyTableId);
        if(monthlyTableEl){
          const tableCanvas = await html2canvas(monthlyTableEl,{useCORS:true, scale:2});
          const tableImg = tableCanvas.toDataURL("image/png");
          pdf.addImage(tableImg,"PNG",10,20,190,0);
        } else {
          pdf.text("Aucun tableau mensuel pour ce scénario.",10,20);
        }

        // 5) PAGE 3 => Graphique
        pdf.addPage();
        pdf.text("Graphique (Détails par mois)",10,10);

        const barCanvas = document.getElementById(barChartId);
        if(barCanvas){
          const barCanvasImg = await html2canvas(barCanvas,{ useCORS:true, scale:2 });
          const chartImgData = barCanvasImg.toDataURL("image/png");
          pdf.addImage(chartImgData,"PNG",10,20,190,90);
        } else {
          pdf.text("Aucun graphique trouvé pour ce scénario.",10,20);
        }

        // 6) PAGE 4 => Projection 20 ans
        pdf.addPage();
        pdf.text("Projection sur 20 ans",10,10);

        const table20El = document.getElementById(table20Id);
        if(table20El){
          const table20Canvas = await html2canvas(table20El,{useCORS:true, scale:2});
          const table20Img = table20Canvas.toDataURL("image/png");
          pdf.addImage(table20Img,"PNG",10,20,190,0);
        } else {
          pdf.text("Aucun tableau de projection 20 ans pour ce scénario.",10,20);
        }

        // 7) PAGE 5 => Chiffres clés
        pdf.addPage();
        pdf.text("Chiffres Clés",10,10);

        const summaryDiv = document.getElementById(summaryId);
        if(summaryDiv){
          const summaryCanvas = await html2canvas(summaryDiv,{useCORS:true, scale:2});
          const summaryImg = summaryCanvas.toDataURL("image/png");
          pdf.addImage(summaryImg,"PNG",10,20,190,0);
        } else {
          pdf.text("Aucun résumé (chiffres clés) pour ce scénario.",10,20);
        }

        // 8) Sauvegarde
        let pdfFileName = "Rapport_Etude.pdf";
        if(companyName){
          pdfFileName = `Rapport_${companyName}.pdf`;
        }
        pdf.save(pdfFileName);

      } catch(e){
        console.error("Erreur exportStudyReportPDF:", e);
        alert("Une erreur est survenue lors de l'export multi-pages. Voir console.");
      }
    }
  </script>
</body>
</html>
